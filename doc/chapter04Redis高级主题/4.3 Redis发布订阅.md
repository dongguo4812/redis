# 定义

Redis发布订阅(pub/sub)是一种消息通信模式：发送者(pub)用来发送消息，订阅者(sub)用来接收消息，可以实现进程间的消息传递。

# 功能

Redis客户端可以订阅任意数量的频道。 类似微信关注多个公众号。

下图展示了频道channel1，以及订阅这个频道的三个客户端client2、client5和client1之间的关系：

![image-20240305103959711](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403051040186.png)

当有新消息通过PUBLISH命令发送给频道channel1时,这个消息就会被发送给订阅它的三个客户端(client2,client5和client1),如下图所示

![image-20240305104046869](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403051040106.png)

Redis发布订阅其实是一个轻量级的队列，只不过数据不会被持久化，一般用来处理实时性较高的异步消息。

# 常用命令

![image-20240305104337028](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403051043133.png)

## SUBSCRIBE channel

订阅给定的一个或多个频道的消息。

推荐先执行订阅后再发布，订阅成功之前发布的消息是收不到的。

订阅的客户端每次可以收到一个3个参数的消息 ：

- 消息的种类 
- 始发频道的名称 
- 实际的消息内容

## PUBLISH channel message

发布消息到指定的频道

## PSUBSCRIBE pattern

按照模式批量订阅，订阅一个或多个符合给定模式(支持* 、？)的频道

## PUBSUB  subcommand

查看订阅与发布系统状态 

### PUBSUB CHANNELS

由活跃频道组成的列表

### PUBSUB NUMSUB

某个频道有多少个订阅者

### PUBSUB NUMPAT

只统计使用PSUBSCRIBE命令执行批量订阅数，返回客户端订阅的唯一模式的数量

## UNSUBSCRIBE channel

取消订阅指定的频道

## PUNSUBSCRIBE pattern

取消订阅所有指定的频道





# 示例

## 订阅

开启3个客户端，演示客户端A、B订阅频道redisChat，客户端C在redisChar频道发布消息

1.客户端A订阅频道redisChat

```shell
127.0.0.1:6379> SUBSCRIBE redisChat
Reading messages... (press Ctrl-C to quit)
1) "subscribe"
2) "redisChat"
3) (integer) 1
```

2.客户端B订阅频道redisChat

```
127.0.0.1:6379> SUBSCRIBE redisChat
Reading messages... (press Ctrl-C to quit)
1) "subscribe"
2) "redisChat"
3) (integer) 1
```



3.客户端C在redisChat频道中发送消息

```shell
127.0.0.1:6379> PUBLISH redisChat hello-redis
(integer) 2
```

4.客户端A、B接收到消息

```shell
1) "message"
2) "redisChat"
3) "hello-redis"
```

## 批量订阅

开启客户端D，批量订阅以redis开头的频道

1.客户端C先查看使用批量订阅的数量

```shell
127.0.0.1:6379> PUBSUB NUMPAT
(integer) 0
```

2.客户端D，批量订阅以redis开头的频道

```shell
127.0.0.1:6379> PSUBSCRIBE redis*
Reading messages... (press Ctrl-C to quit)
1) "psubscribe"
2) "redis*"
3) (integer) 1
```

3.客户端C再次查看使用批量订阅的数量

```shell
127.0.0.1:6379> PUBSUB NUMPAT
(integer) 1
```

4.客户端C在redisChat频道中发送消息，有3个客户端接收到了消息

```shell
127.0.0.1:6379> PUBLISH redisChat hello-redis
(integer) 3
```

5.客户端C查看redisChat频道有几个订阅者，这里不包含PSUBSCRIBE的订阅数

```shell
127.0.0.1:6379> PUBSUB NUMSUB redisChat
1) "redisChat"
2) (integer) 2
```

## 取消订阅

客户端A取消订阅redisChat频道，订阅后无法进行操作，先ctrl+c退出客户端，重新连接客户端进行取消订阅

```shell
^C
[root@redis bin]# redis-cli -a root
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:6379> UNSUBSCRIBE redisChat
1) "unsubscribe"
2) "redisChat"
3) (integer) 0
```

## 批量取消订阅

客户端D批量取消订阅以redis开头的频道

```shell
^C
[root@redis ~]# redis-cli -a root
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:6379> PUNSUBSCRIBE redis*
1) "punsubscribe"
2) "redis*"
3) (integer) 0
```

# 发布订阅缺点

发布的消息在Redis系统中不能持久化，因此必须先执行订阅，再等待消息发布。如果先发布了消息，那么该消息由于没有订阅者，消息将直接被丢弃。

消息只管发送对于发布者而言消息是即发即失的，不管接收，也没有ACK机制，无法保证消息的消费成功。