# 如何优化频繁命令往返造成的性能瓶颈

Redis是一种基于客户端-服务端模型以及请求/响应协议的TCP服务。一个请求会遵循以下步骤：

1客户端向服务端发送命令分四步(发送命令→命令排队→命令执行→返回结果)，并监听Socket返回，通常以阻塞模式等待服务端响应。

2服务端处理命令，并将结果返回给客户端。

上述两步称为： Round Trip Time(简称RTT,数据包往返于两端的时间)。

![image-20240305090104035](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403050903306.png)

如果同时需要执行大量的命令,那么就要等待上一条命令应答后再执行,这中间不仅仅多了RTT (Round Time Trip) ,而且还频繁调用系统IO,发送网络请求,同时需要redis调用多次read()和write()系统方法,系统方法会将数据从用户态转移到内核态,这样就会对进程上下文有比较大的影响，性能不太好。

## 解决思路

引出管道这个概念。

管道（pipeline）可以一次性发送多条命令给服务端，服务端依次处理完完毕后，通过一条响应一次性将结果返回，通过减少客户端与redis的通信次数来实现降低往返延时时间。pipeline实现的原理是队列,先进先出特性就保证数据的顺序性。

![image-20240305090608108](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403050906405.png)

# Pipeline管道

Pipeline将命令打包一次性发送，降低了RTT往返时间，是批处理命令变种优化措施。类似redis的原生批处理命令（mget 和 mset ）。Pipeline可以批处理不同类型的命令