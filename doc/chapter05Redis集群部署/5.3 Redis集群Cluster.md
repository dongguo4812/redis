通过哨兵模式集群的配置，我们可以看出哨兵集群模式是基于主从模式的，哨兵模式具有所有主从的优点。

哨兵模式是主从模式的升级，实现了自动化的故障恢复。但哨兵模式的缺点也很明显，Redis较难实现支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。

实现哨兵模式的配置也不简单，甚至有些繁琐，于是就有了Redis Cluster集群。Redis Cluster是官方的Redis集群实现。

Redis Cluster集群是一个由多个主从节点组成的分布式服务器群，它具有复制、高可用和分片特性。

Redis集群将所有数据存储区域划分为16384个槽位(slots)，每个节点负责一部分槽位，槽位的信息存储于每个节点中。Redis集群要将每个节点设置成集群模式，它没有中心节点，可水平扩展，它的性能和高可用性均优于主从模式和哨兵模式，而且集群配置非常简单。

Redis集群架构图如下图所示。

![image-20240306192928018](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403061929227.png)

# 作用

 1.redis集群可以支持多个master 每个master又可以挂载多个slave

​		实现读写分离， 支持数据的高可用 ，  支持海量数据的读写存储操作

2.由于cluster自带sentinel的故障转移机制，内置了高可用的支持，无需再去使用哨兵功能

3.客户端与redis的节点连接，不再需要连接集群中所有的节点，只需要任意连接集群中的一个可用节点即可

4.槽位slot负责分配到各个物理服务节点，由对应的集群来负责维护节点，插槽和数据之间的关系

# 集群算法

## Redis集群的槽位slot

Redis集群没有使用一致性hash算法，而是引入了哈希槽的概念。

Redis集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽。集群的每个节点负责一部分hash槽，举个例子，比如当前集群有3个节点那么：

![image-20240306194605805](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403061946695.png)

## Redis集群的分片

使用Redis集群时我们会将存储的数据分散到多台redis机器上，这称为分片。简言之，集群中的每个Redis实例都被认为是整个数据的一个分片。

### 如何找到给定key的分片

为了找到给定key的分片，我们对key进行CRC16(key)算法处理并通过对总分片数量取模。然后使用确定性哈希函数，这意味着给定的key将多次始终映射到同一个分片，我们可以推断将来读取特定key的位置。

## 哈希槽和分片的优势

方便扩缩容和数据分派查找

1. **添加新节点**：如果想向集群中添加一个新节点（例如节点D），需要从现有节点（例如节点A、B、C）中取出部分哈希槽并分配给新节点D。这个过程可以通过Redis的`CLUSTER ADDSLOTS`命令完成。

2. **删除节点**：如果想从集群中删除一个节点（例如节点A），您需要先将节点A中的所有哈希槽移动到其他节点（例如节点B和C）上。这可以通过Redis的`CLUSTER DELSLOTS`和`CLUSTER SETSLOT`命令完成。一旦节点A中的所有槽都被移动走，它就不再负责任何数据，此时可以安全地将其从集群中移除。

3. **重新分配哈希槽**：即使集群在运行过程中，也可以根据需要重新分配哈希槽。例如，如果某个节点因为硬件故障或其他原因变得不可用，可以将该节点的哈希槽重新分配到其他健康节点上。这个过程同样不会导致服务中断，因为Redis集群在处理哈希槽的移动时，会确保相关的键值对在新的节点上可用。

   所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态。

## slot槽位映射的三种方案

决定槽位落到那个分区上的算法，推荐哈希槽方案。

### 哈希取余分区

假设有3台机器构成一个集群，用户每次读写操作都是根据公式：hash(key)%N个机器台数，计算出哈希值，用来决定数据映射到哪一个节点上。

![image-20240306201521468](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062015070.png)

#### 优点：

简单粗暴，直接有效，只需要预估好数据规划好节点，例如3台、8台、10台，就能保证一段时间的数据支撑。使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器固定处理一部分请求(并维护这些请求的信息），起到负载均衡+分而治之的作用。

#### 缺点：

原来规划好的节点，进行扩容或者缩容就比较麻烦了，不管扩缩，每次数据变动导致节点有变动，映射关系需要重新进行计算，在服务器个数固定不变时没有问题，如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化：Hash(key)/3会变成Hash(key)/?。此时地址经过取余运算的结果将发生很大变化，根据公式获取的服务器也会变得不可控。某个redis机器宕机了，由于节点数量变化，会导致hash取余全部数据重新洗牌。

### 一致性哈希算法分区

用于解决分布式系统中的数据分布问题。一致性哈希算法的主要特点是，在节点（例如服务器）增加或减少时，它能够尽可能少地改变已存在的键值对到节点的映射关系，从而减少数据的迁移量。

一致性哈希算法主要包括以下三个步骤：

#### 1.构建一致性哈希环

一致性哈希算法必然有个hash函数并按照算法产生hash值，这个算法的所有可能哈希值会构成一个全量集，这个集合可以成为一个hash空间[0，2へ32-1]，这个是一个线性空间，但是在算法中，我们通过适当的逻辑控制将它首尾相连（0=2へ32），这样让它逻辑上形成了一个环形空间。

它也是按照使用取模的方法，一致性Hash算法是对2^32取模，简单来说，一致性Hash算法将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数H的值空间为0-2^32-1(即哈希值是一个32位无符号整形），整个哈希环如下图：

整个空间按顺时针方向组织，圆环的正上方的点代表0，0点右侧的第一个点代表1，以此类推，2、3、4、……直到2へ32-1，也就是说0点左侧的第一个点代表2へ32-1，我们把这个由2へ32个点组成的圆环称为Hash环。

![image-20240306203946253](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062039200.png)

#### 2.redis服务器ip节点映射

将集群中各个IP节点映射到环上的某一个位置。

将各个服务器使用Hash进行一个哈希，具体可以选择服务器的IP或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假如4个节点NodeA、B、C、D，节点的位置是由IP地址经过哈希函数计算(hash(ip))得到的，如下:

![image-20240306204128536](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062041462.png)

#### 3.key在服务器的落键规则

当我们需要存储一个kv键值对时，首先计算key的hash值，hash(key)，将这个key使用相同的函数Hash计算出哈希值并确定此数据在环上的位置，从此位置沿环顺时针查找，第一台遇到的服务器就是其应该定位到的服务器，并将该键值对存储在该节点上。

如我们有Object A、Object B、Object C、Object D四个数据对象，经过哈希计算后，在环空间上的位置如下：根据一致性Hash算法，数据A会被定为到Node A上，B被定为到Node B上，C被定为到Node C上，D被定为到Node D上。

![image-20240306204901954](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062049441.png)

#### 优点

##### 容错性

假设Node C宕机，可以看到此时对象A、B、D不会受到影响。一般的，在一致性Hash算法中，如果一台服务器不可用，则受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿着逆时针方向行走遇到的第一台服务器）之间数据，其它不会受到影响。简单说，就是C挂了，受到影响的只是B、C之间的数据且这些数据会转移到D进行存储。

![image-20240306205358766](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062053688.png)

##### 扩展性

数据量增加了，需要增加一台节点NodeX，X的位置在A和B之间，那收到影响的也就是A到X之间的数据，重新把A到X的数据录入到X上即可，不会导致hash取余全部数据重新洗牌。

![image-20240306205428692](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062054716.png)

#### 缺点

一致性哈希算法的数据倾斜问题

一致性Hash算法在服务节点太少时，容易因为节点分布不均匀而造成数据倾斜（被缓存的对象大部分集中缓存在某一台服务器上）问题，例如系统中只有两台服务器：

![image-20240306205549486](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062055362.png)

### 哈希槽分区

Redis集群没有使用一致性hash算法，而是引入了哈希槽的概念，解决一致性哈希算法的数据倾斜问题。

哈希槽实质就是一个数组，数组[0,2へ14-1]形成hash slot空间。

解决均匀分配的问题，在数据和节点之间又加入了一层，把这层称为哈希槽(slot)，用于管理数据和节点之间的关系，现在就相当于节点上放的是槽，槽里放的是数据。

![image-20240306205852207](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062058604.png)

槽解决的是粒度问题，相当于把粒度变大了，这样便于数据移动。哈希解决的是映射问题，使用key的哈希值来计算所在的槽，便于数据分配

一个集群只能有16384个槽，编号0-16383（0-2へ14-1）。这些槽会分配给集群中的所有主节点，分配策略没有要求。集群会记录节点和槽的对应关系，解决了节点和槽的关系后，接下来就需要对key求哈希值，然后对16384取模，余数是几key就落入对应的槽里。HASH_SLOT=CRC16(key)mod 16384。以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。

#### 哈希槽的计算

Redis集群中内置了16384个哈希槽，redis会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在Redis集群中放置一个key-value时，redis先对key使用crc16算法算出一个结果然后用结果对16384求余数[CRC16（key)% 16384]，这样每个key 都会对应一个编号在0-16383之间的哈希槽，也就是映射到某个节点上。

如下代码，key之A、B在Node2，key之C落在Node3上

![image-20240306210204589](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062102235.png)

#### 为什么redis集群的最大槽数是16384个？

Redis集群并没有使用一致性hash而是引入了哈希槽的概念。Redis集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽，集群的每个节点负责一部分hash槽。但为什么哈希槽的数量是16384（2^14）个呢？

CRC16算法产生的hash值有16bit，该算法可以产生2^16=65536个值。换句话说值是分布在0~65535之间，有更大的65536不用为什么只用16384就够?作者在做mod运算的时候，为什么不mod65536,而选择mod16384?

HASH_SLOT=CRC16(key)mod 65536为什么没启用？



在github同样有人提出这个问题：[why redis-cluster use 16384 slots?](https://github.com/redis/redis/issues/2576)

Redis的作者回答：

正常的心跳数据包带有节点的完整配置，可以用幂等方式用旧的节点替换旧节点，以便更新旧的配置。

这意味着它们包含原始节点的插槽配置，该节点使用2k的空间和16k的插槽，但是会使用8k的空间（使用65k的插槽）。

同时，由于其他设计折衷，Redis集群不太可能扩展到1000个以上的主节点。

因此16k处于正确的范围内，以确保每个主机具有足够的插槽，最多可容纳1000个矩阵，但数量足够少，可以轻松地将插槽配置作为原始位图传播。请注意，在小型群集中，位图将难以压缩，因为当N较小时，位图将设置的slot/N位占设置位的很大百分比。

![image-20240306210820018](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403062108061.png)

（1）如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大。

在消息头中最占空间的是myslots[CLUSTER_SLOTS/8]。当槽位为65536时，这块的大小是：65536=8=1024=8kb

在消息头中最占空间的是myslots[CLUSTER_SLOTS/8]。当槽位为16384时，这块的大小是：16384=8=1024=2kb

因为每秒钟，redis节点需要发送一定数量的ping消息作为心跳包，如果槽位为65536，这个ping消息的消息头太大了，浪费带宽。

（2）redis的集群主节点数量基本不可能超过1000个。

集群节点越多，心跳包的消息体内携带的数据越多。如果节点过1000个，也会导致网络拥堵。

因此redis作者不建议redis cluster节点数量超过1000个。那么，对于节点数在1000以内的redis cluster集群，16384个槽位够用了。没有必要拓展到65536个。

（3）槽位越小，节点少的情况下，压缩比高，容易传输

Redis主节点的配置信息中它所负责的哈希槽是通过一张bitmap的形式来保存的，在传输过程中会对bitmap进行压缩，但是如果bitmap的填充率slots/ N很高的话（N表示节点数)，bitmap的压缩率就很低。如果节点数很少，而哈希槽数量很多的话，bitmap的压缩率就很低。

## Redis集群不保证强一致性，这意味着在特定的条件下，Redis集群可能会丢掉一些被系统收到的写入请求命令

**写安全性**：Redis集群在节点之间复制数据时，不是同步进行的，而是异步的。当某个节点出现故障时，集群会进行故障转移，并有一个隐含的合并功能，使得最后选定的主节点数据集会覆盖所有的从节点数据。这意味着在某些情况下，如果在数据分区时发生写入操作，这些写入的数据可能会丢失。





# 3主3从Redis集群搭建

集群3主3从，信息如下：

6个实例均是哨兵时所用的实例

| IP              | PORT | 角色   |
| --------------- | ---- | ------ |
| 192.168.122.132 | 7001 | master |
| 192.168.122.133 | 7002 | master |
| 192.168.122.134 | 7003 | master |
| 192.168.122.135 | 7004 | slave  |
| 192.168.122.136 | 7005 | slave  |
| 192.168.122.137 | 7006 | slave  |

## 启动6个独立的redis实例

在myredis目录下创建cluster文件夹用于存放相关文件，6个redis实例都是类似相同的配置

```shell
[root@redis-7001 myredis]# mkdir cluster
[root@redis-7001 myredis]# ll
总用量 24
drwxr-xr-x. 2 root root     6 3月   7 08:06 cluster
-rw-r--r--. 1 root root   239 3月   6 16:02 dump7001.rdb
-rw-r--r--. 1 root root 17326 3月   6 16:02 redis.log
[root@redis-7001 myredis]# vim /myredis/cluster/rediscluster7001.conf
```

### 相关配置

其他实例适当修改下端口就可以了

```shell
# 绑定地址
bind 0.0.0.0
# 让redis后台运行
daemonize yes
port 7001
# 日志
logfile /myredis/cluster/cluster7001.log
#PID写入的文件目录
pidfile /myredis/cluster/redis7001.pid
# 持久化文件存放目录
dir /myredis/cluster
#开启AOF持久化
appendonly yes
appendfilename "appendonly7001.aof"
#密码
requirepass  root  
masterauth root

# 开启集群功能
cluster-enabled yes
# 集群的配置文件名称，不需要我们创建，由redis自己维护
cluster-config-file nodes-7001.conf
# 节点心跳失败的超时时间
cluster-node-timeout 5000
```

### 启动6个redis实例

```shell
[root@redis-7001 myredis]# redis-server /myredis/cluster/rediscluster7001.conf 
```

查看redis服务端是否启动成功

```shell
[root@redis-7001 myredis]# ps -ef |grep redis
root       1213      1  0 08:25 ?        00:00:00 redis-server 0.0.0.0:7001 [cluster]
root       1219   1118  0 08:25 pts/0    00:00:00 grep --color=auto redis
```



## 通过redisl-cli命令构建集群关系

### 构建集群关系

集群管理以及集成到了redis-cli中，格式如下：

```shell
redis-cli -a root --cluster create --cluster-replicas 1 192.168.122.132:7001 192.168.122.133:7002 192.168.122.134:7003 192.168.122.135:7004 192.168.122.136:7005 192.168.122.137:7006
```

命令说明：

- redis-cli --cluster：代表集群操作命令

- create：代表是创建集群

- --replicas 1 或者--cluster-replicas 1 ：指定集群中每个master的副本个数为1，此时节点总数 ÷ (replicas + 1) 得到的就是master的数量。因此节点列表中的前n个就是master，其它节点都是slave节点，随机分配到不同master

```shell
[root@redis-7001 myredis]# redis-cli -a root --cluster create --cluster-replicas 1 192.168.122.132:7001 192.168.122.133:7002 192.168.122.134:7003 192.168.122.135:7004 192.168.122.136:7005 192.168.122.137:7006
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
>>> Performing hash slots allocation on 6 nodes...
Master[0] -> Slots 0 - 5460
Master[1] -> Slots 5461 - 10922
Master[2] -> Slots 10923 - 16383
Adding replica 192.168.122.136:7005 to 192.168.122.132:7001
Adding replica 192.168.122.137:7006 to 192.168.122.133:7002
Adding replica 192.168.122.135:7004 to 192.168.122.134:7003
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[0-5460] (5461 slots) master
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[5461-10922] (5462 slots) master
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[10923-16383] (5461 slots) master
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
Can I set the above configuration? (type 'yes' to accept): yes
>>> Nodes configuration updated
>>> Assign a different config epoch to each node
>>> Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join
.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

从以下信息可以看出，master:7001, slave:7005; master:7002,slave:7006; master:7003,slave:7004。这里输入yes，则集群开始创建,构建了3主3从redis集群

```shell
: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[0-5460] (5461 slots) master
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[5461-10922] (5462 slots) master
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[10923-16383] (5461 slots) master
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
   Can I set the above configuration? (type 'yes' to accept): yes
```

### 查看集群状态

以7001节点为例，连接7001客户端

```shell
[root@redis-7001 myredis]# redis-cli -a root -p 7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7001> 
```

#### info replication 获取7001master节点的主从关系

```shell
127.0.0.1:7001> info replication
# Replication
role:master
connected_slaves:1
slave0:ip=192.168.122.136,port=7005,state=online,offset=2296,lag=1
master_failover_state:no-failover
master_replid:88643598088c9d45eeabc24050a165f01946b33d
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:2296
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:2296
```

#### cluster info获取集群状态信息

```shell
127.0.0.1:7001> cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:1
cluster_stats_messages_ping_sent:3220
cluster_stats_messages_pong_sent:3194
cluster_stats_messages_sent:6414
cluster_stats_messages_ping_received:3189
cluster_stats_messages_pong_received:3220
cluster_stats_messages_meet_received:5
cluster_stats_messages_received:6414
```

#### cluster nodes获取集群节点信息

```shell
127.0.0.1:7001> cluster nodes
9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005@17005 slave 19ebecba98d2e33ba184d396e630a9e6434e4196 0 1709777197000 1 connected
d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004@17004 slave e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 0 1709777197274 3 connected
e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003@17003 master - 0 1709777197778 3 connected 10923-16383
21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006@17006 slave 318bf90e3c9922aadf8e72734c86a75fd1ab571d 0 1709777196770 2 connected
19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001@17001 myself,master - 0 1709777196000 1 connected 0-5460
318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002@17002 master - 0 1709777197000 2 connected 5461-10922
```

# 3主3从Redis集群读写

1.7001节点写入k1，k2

```shell
127.0.0.1:7001> set k1 v1
(error) MOVED 12706 192.168.122.134:7003
127.0.0.1:7001> set k2 v2
OK
127.0.0.1:7001> keys *
1) "k2"
```

2.发现写入k1提示(error) MOVED 12706 192.168.122.134:7003，写入k2成功，获取key时只能获取到k2，这是怎么回事呢？

因为 `k1` 所属的槽位（slot）12706 并不在当前的节点 `7001` 上，而是被分配到了 `192.168.122.134:7003` 这个节点上。



3.到7003节点查看是否存在k1

```shell
[root@redis-7003 myredis]# redis-cli -a root -p 7003
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7003> get k1
(nil)
```

4.发现7003并没有k1。这又是怎么回事呢？

因为在启动 Redis 客户端时没有使用 `-c`（或者 `--cluster`）选项，客户端将不会以集群模式运行。客户端就不会理解 `MOVED` 错误，也不会自动重定向请求到正确的节点。

在集群模式下，Redis 客户端需要能够处理槽位重定向（slot redirection），这是集群如何知道哪个节点负责存储特定键的机制。



5.重新连接7001客户端增加参数==-c==，此时写入k1提示Redirected to slot [12706] located at 192.168.122.134:7003，重定向到了7003节点，注意这里的客户端已经变为192.168.122.134:7003了，所以`keys *`只能查到7003节点上的k1。`get k2`时k2位于7001节点上，客户端又切换回7001了。

```shell
127.0.0.1:7001> quit
[root@redis-7001 myredis]# redis-cli -a root -p 7001 -c
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7001> set k1 v1
-> Redirected to slot [12706] located at 192.168.122.134:7003
OK
192.168.122.134:7003> keys *
1) "k1"
127.0.0.1:7001> get k2
"v2"
127.0.0.1:7001> keys *
1) "k2"
```

6.查看某个key在哪个槽位上`CLUSTER KEYSLOT key`

```shell
127.0.0.1:7001> CLUSTER KEYSLOT k1
(integer) 12706
```

# 主从容错切换迁移

## 主机7001和从机7005切换，先停止主机7001

```shell
127.0.0.1:7001> shutdown
not connected> quit
```

## 使用其他节点比如7002，查看redis集群节点信息

```shell
[root@redis-7002 myredis]# redis-cli -a root -p 7002 -c
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7002> cluster nodes
e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003@17003 master - 0 1709779840000 3 connected 10923-16383
d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004@17004 slave e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 0 1709779841132 3 connected
9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005@17005 master - 0 1709779841000 7 connected 0-5460
21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006@17006 slave 318bf90e3c9922aadf8e72734c86a75fd1ab571d 0 1709779840122 2 connected
318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002@17002 myself,master - 0 1709779839000 2 connected 5461-10922
19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001@17001 master,fail - 1709779685545 1709779683000 1 disconnected
```

19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001@17001 master,fail - 1709779685545 1709779683000 1 disconnected  表示7001节点已经挂掉。

之前的slave7005变成了新的master7005。当前集群为3主2从。

## 重新启动7001，查看redis集群节点信息

```shell
[root@redis-7001 myredis]# redis-server /myredis/cluster/rediscluster7001.conf 
[root@redis-7001 myredis]# redis-cli -a root -p 7001 -c
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7001> info replication
# Replication
role:slave
master_host:192.168.122.136
master_port:7005
master_link_status:up
master_last_io_seconds_ago:8
master_sync_in_progress:0
slave_read_repl_offset:6366
slave_repl_offset:6366
slave_priority:100
slave_read_only:1
replica_announced:1
connected_slaves:0
master_failover_state:no-failover
master_replid:c69af06c905e65786f4e4a4ae3cd000d7654fe51
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:6366
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:6059
repl_backlog_histlen:308
127.0.0.1:7001> cluster nodes
d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004@17004 slave e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 0 1709780214775 3 connected
19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001@17001 myself,slave 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 0 1709780214000 7 connected
9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005@17005 master - 0 1709780214000 7 connected 0-5460
318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002@17002 master - 0 1709780215077 2 connected 5461-10922
e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003@17003 master - 0 1709780214000 3 connected 10923-16383
21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006@17006 slave 318bf90e3c9922aadf8e72734c86a75fd1ab571d 0 1709780215279 2 connected
```

原master7001重启后变为了slave7001，它的master是7005

## 手动故障转移

设计之初为master7001、slave7005，现在节点从属关系发生了变化，如何调整节点从属呢？

在7001节点上执行`CLUSTER FAILOVER`命令

```shell
127.0.0.1:7001> cluster nodes
d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004@17004 slave e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 0 1709781336076 3 connected
19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001@17001 myself,slave 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 0 1709781335000 7 connected
9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005@17005 master - 0 1709781334063 7 connected 0-5460
318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002@17002 master - 0 1709781334567 2 connected 5461-10922
e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003@17003 master - 0 1709781334567 3 connected 10923-16383
21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006@17006 slave 318bf90e3c9922aadf8e72734c86a75fd1ab571d 0 1709781335069 2 connected
127.0.0.1:7001> CLUSTER FAILOVER
OK
127.0.0.1:7001> cluster nodes
d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004@17004 slave e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 0 1709781346143 3 connected
19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001@17001 myself,master - 0 1709781345000 8 connected 0-5460
9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005@17005 slave 19ebecba98d2e33ba184d396e630a9e6434e4196 0 1709781345000 8 connected
318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002@17002 master - 0 1709781345000 2 connected 5461-10922
e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003@17003 master - 0 1709781345539 3 connected 10923-16383
21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006@17006 slave 318bf90e3c9922aadf8e72734c86a75fd1ab571d 0 1709781345137 2 connected
```

此时7001重新变为master，7005又变回了slave。

在正常的故障转移机制中，如果一个主节点故障了，其中一个从节点会自动提升为新的主节点，其他从节点则会更新它们的主节点为新的主节点。当在7001 上执行 `CLUSTER FAILOVER` 命令时，该节点会尝试断开与当前主节点7005的复制关系，并尝试将自己提升为新的主节点。并且其他从节点（包括原先的 7005）会开始复制新的主节点 7001。

手动触发故障转移应该谨慎进行，不正确的操作可能导致集群状态进一步混乱或数据丢失。

## 集群极端情况下存在数据丢失的问题

Redis集群不保证强一致性,这意味着在特定的条件下,Redis集群可能会丢掉一些被系统收到的写入请求命令

**异步复制**：Redis 集群使用异步复制来保持节点之间的数据一致性。当主节点接收到写请求并执行后，它会将命令复制给从节点，但从节点的应用这些命令是异步的。如果主节点在复制完成前发生故障，那么从节点可能还没有应用这些写请求，导致数据丢失。

**故障转移**：当主节点发生故障时，Redis 集群会触发故障转移机制，将一个从节点提升为新的主节点。在这个过程中，可能会存在一段时间的数据不一致，因为新的主节点可能还没有接收到所有之前的写请求。

# 集群扩容

3主3从扩容为4主4从

新增两台实例，从192.168.122.132克隆过来

| IP              | PORT | 角色   |
| --------------- | ---- | ------ |
| 192.168.122.138 | 7007 | master |
| 192.168.122.139 | 7008 | slave  |

## 修改配置文件

以7007为例

```shell
[root@redis-7007 ~]# cd /myredis/cluster/
[root@redis-7007 cluster]# mv rediscluster7001.conf rediscluster7007.conf 
[root@redis-7007 cluster]# vim rediscluster7007.conf 
```

相关配置

```shell
# 绑定地址
bind 0.0.0.0
# 让redis后台运行
daemonize yes
port 7007
# 日志
logfile /myredis/cluster/cluster7007.log
#PID写入的文件目录
pidfile /myredis/cluster/redis7007.pid
# 持久化文件存放目录
dir /myredis/cluster
#开启AOF持久化
appendonly yes
appendfilename "appendonly7007.aof"
#密码
requirepass  root
masterauth root

# 开启集群功能
cluster-enabled yes
# 集群的配置文件名称，不需要我们创建，由redis自己维护
cluster-config-file nodes-7007.conf
# 节点心跳失败的超时时间
cluster-node-timeout 5000
```

## 启动两个新的节点实例

7007

```shell
[root@redis-7007 cluster]# redis-server /myredis/cluster/rediscluster7007.conf 
```

7008

```shell
[root@redis-7008 cluster]# redis-server /myredis/cluster/rediscluster7008.conf 
```

此时这两个节点都是独立的master

## 将7007节点（空槽位）作为master加入redis集群

该命令是用来将一个新的 Redis 节点添加到现有的 Redis 集群中的。新加入的节点会作为一个没有分配任何数据槽位（slot）的master节点存在。

```shell
redis-cli -a root --cluster add-node 192.168.122.138:7007 192.168.122.132:7001 
```

- `192.168.122.138:7007`：这是新节点的 IP 地址和端口号。

- `192.168.122.132:7001`：这是现有集群中任意一个节点的 IP 地址和端口号。`redis-cli` 会使用这个节点的信息来找到集群中的其他节点，并通知它们新节点的加入。

  显示加入成功Adding node 192.168.122.138:7007 to cluster 192.168.122.132:7001

```shell
[root@redis-7007 cluster]# redis-cli -a root --cluster add-node 192.168.122.138:7007 192.168.122.132:7001 
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
>>> Adding node 192.168.122.138:7007 to cluster 192.168.122.132:7001
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
>>> Send CLUSTER MEET to node 192.168.122.138:7007 to make it join the cluster.
[OK] New node added correctly.
```

### 检查 Redis 集群状态

`redis-cli --cluster check` 是一个用于检查 Redis 集群状态的命令。

```shell
redis-cli -a root --cluster check 192.168.122.132:7001
```

- `--cluster check`：告诉 `redis-cli` 要检查集群的状态。

- `192.168.122.132:7001`:这是集群中任意一个节点的 IP 地址和端口号。`redis-cli` 会尝试连接到这个节点，并从那里获取整个集群的信息。

  可以看到master7007暂时还没有分配槽位slot

```shell
[root@redis-7007 cluster]# redis-cli -a root --cluster check 192.168.122.132:7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
192.168.122.132:7001 (19ebecba...) -> 1 keys | 5461 slots | 1 slaves.
192.168.122.134:7003 (e49ab26e...) -> 1 keys | 5461 slots | 1 slaves.
192.168.122.133:7002 (318bf90e...) -> 0 keys | 5462 slots | 1 slaves.
192.168.122.138:7007 (c2e3aa09...) -> 0 keys | 0 slots | 0 slaves.
[OK] 2 keys in 4 masters.
0.00 keys per slot on average.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
M: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 192.168.122.138:7007
   slots: (0 slots) master
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

## 重新分配哈希槽 (reshard)

**reshard操作是将Redis节点负责的Slot进行重分配**。

```shell
redis-cli -a root --cluster reshard 192.168.122.132:7001
```

- 192.168.122.132:7001:这是集群中任意一个节点的 IP 地址和端口号。`redis-cli` 会与该节点通信并获取整个集群的状态

```shell
[root@redis-7007 cluster]# redis-cli -a root --cluster reshard 192.168.122.132:7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
M: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 192.168.122.138:7007
   slots: (0 slots) master
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
How many slots do you want to move (from 1 to 16384)? 
```

询问想要移动多少个槽位数。现在有4个主节点，平均分配每个节点分配4096个槽位，将4096个槽位分配给7007节点

```shell
How many slots do you want to move (from 1 to 16384)? 4096
What is the receiving node ID? 
```

询问接收这些槽位的节点ID是多少，7007对应的节点ID是c2e3aa097b500f6e81eafb2cb6f60d68fe726e98

```shell
What is the receiving node ID? c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
Please enter all the source node IDs.
  Type 'all' to use all the nodes as source nodes for the hash slots.
  Type 'done' once you entered all the source nodes IDs.
Source node #1: 
```

要求输入所有源节点的ID，即由哪些节点提供槽位。

all：从集群中的所有节点迁移哈希槽。

done: 从指定节点（一个或多个）中迁移哈希槽， 'done' 来表示输入完毕。

这里直接输入all即可，从整个集群的所有节点中都迁移出一部分哈希槽，然后分配给7007。

```shell
    ......
    Moving slot 12280 from e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
    Moving slot 12281 from e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
    Moving slot 12282 from e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
    Moving slot 12283 from e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
    Moving slot 12284 from e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
    Moving slot 12285 from e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
    Moving slot 12286 from e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
    Moving slot 12287 from e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
Do you want to proceed with the proposed reshard plan (yes/no)? 
```

询问是否想要按照提出的reshard计划进行操作。当然是yes

### 再次检查Redis 集群状态

现在每个节点都分配了4096个哈希槽，各节点slot分配情况：

slots:[0-1364],[5461-6826],[10923-12287] 分配给了7007

slots:[1365-5460] 分配给了7001

slots:[6827-10922]分配给了7002

slots:[12288-16383] 分配给了7003

```shell
[root@redis-7007 cluster]# redis-cli -a root --cluster check 192.168.122.132:7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
192.168.122.132:7001 (19ebecba...) -> 0 keys | 4096 slots | 1 slaves.
192.168.122.134:7003 (e49ab26e...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.133:7002 (318bf90e...) -> 0 keys | 4096 slots | 1 slaves.
192.168.122.138:7007 (c2e3aa09...) -> 1 keys | 4096 slots | 0 slaves.
[OK] 2 keys in 4 masters.
0.00 keys per slot on average.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[1365-5460] (4096 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 192.168.122.138:7007
   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

## 为master7007分配slave7008

```
redis-cli -a root --cluster add-node 192.168.122.139:7008 192.168.122.132:7001 --cluster-slave --cluster-master-id c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
```

- `192.168.122.139:7008`: 这是新节点的IP地址和端口号。

- `192.168.122.132:7001`: 这是集群中任意一个已存在节点的IP地址和端口号，`redis-cli`将使用这个节点作为入口点来添加新节点。
- `--cluster-slave`: 表示新节点应该被添加为从节点，而不是主节点。

- `--cluster-master-id c2e3aa097b500f6e81eafb2cb6f60d68fe726e98`: 指定新从节点应该复制的主节点的ID。主节点的ID`c2e3aa097b500f6e81eafb2cb6f60d68fe726e98`对应的节点时7007。

Adding node 192.168.122.139:7008 to cluster 192.168.122.132:7001,192.168.122.139:7008加入到了redis集群

```shell
[root@redis-7007 cluster]# redis-cli -a root --cluster add-node 192.168.122.139:7008 192.168.122.132:7001 --cluster-slave --cluster-master-id c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
>>> Adding node 192.168.122.139:7008 to cluster 192.168.122.132:7001
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[1365-5460] (4096 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 192.168.122.138:7007
   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
>>> Send CLUSTER MEET to node 192.168.122.139:7008 to make it join the cluster.
Waiting for the cluster to join

>>> Configure node as replica of 192.168.122.138:7007.
[OK] New node added correctly.
[root@redis-7007 cluster]# 
```

### 再次检查Redis集群状态

4主4从Redis集群

```shell
[root@redis-7007 cluster]# redis-cli -a root --cluster check 192.168.122.132:7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
192.168.122.132:7001 (19ebecba...) -> 0 keys | 4096 slots | 1 slaves.
192.168.122.134:7003 (e49ab26e...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.133:7002 (318bf90e...) -> 0 keys | 4096 slots | 1 slaves.
192.168.122.138:7007 (c2e3aa09...) -> 1 keys | 4096 slots | 1 slaves.
[OK] 2 keys in 4 masters.
0.00 keys per slot on average.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[1365-5460] (4096 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
S: 52f908ae0c8e74f7375a679b6bad3250bd018f86 192.168.122.139:7008
   slots: (0 slots) slave
   replicates c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 192.168.122.138:7007
   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

查看master7007的主从信息

```shell
[root@redis-7007 cluster]# redis-cli -a root -p 7007 -c
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7007> info replication
# Replication
role:master
connected_slaves:1
slave0:ip=192.168.122.139,port=7008,state=online,offset=406,lag=1
master_failover_state:no-failover
master_replid:64ef408727e9f708a7c27aae26b39accf2e7c161
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:406
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:406
```

## 测试集群写入

```shell
127.0.0.1:7007> set k1 v1
-> Redirected to slot [12706] located at 192.168.122.134:7003
OK
192.168.122.134:7003> set k2 v2
-> Redirected to slot [449] located at 192.168.122.138:7007
OK
192.168.122.138:7007> set k3 v3
-> Redirected to slot [4576] located at 192.168.122.132:7001
OK
192.168.122.132:7001> set k4 v4
-> Redirected to slot [8455] located at 192.168.122.133:7002
OK
192.168.122.133:7002> get k1
-> Redirected to slot [12706] located at 192.168.122.134:7003
"v1"
192.168.122.134:7003> get k2
-> Redirected to slot [449] located at 192.168.122.138:7007
"v2"
192.168.122.138:7007> get k3
-> Redirected to slot [4576] located at 192.168.122.132:7001
"v3"
192.168.122.132:7001> get k4
-> Redirected to slot [8455] located at 192.168.122.133:7002
"v4"
```

# 集群缩容

将4主4从的Redis集群缩容为3主3从。步骤：

1.先删除从节点7008

2.将主节点7007的所有槽位重新分配给7001

3.删除主节点7008

4.缩容为3主3从Redis集群

## 检查集群情况，获得从节点7008的节点ID

7008的节点ID：52f908ae0c8e74f7375a679b6bad3250bd018f86

```shell
[root@redis-7001 ~]# redis-cli -a root --cluster check 192.168.122.132:7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
192.168.122.132:7001 (19ebecba...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.134:7003 (e49ab26e...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.133:7002 (318bf90e...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.138:7007 (c2e3aa09...) -> 1 keys | 4096 slots | 1 slaves.
[OK] 4 keys in 4 masters.
0.00 keys per slot on average.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[1365-5460] (4096 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
S: 52f908ae0c8e74f7375a679b6bad3250bd018f86 192.168.122.139:7008
   slots: (0 slots) slave
   replicates c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 192.168.122.138:7007
   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

## Redis集群删除从节点7008

```shell
redis-cli -a root --cluster del-node 192.168.122.139:7008 52f908ae0c8e74f7375a679b6bad3250bd018f86
```

- `del-node`: 用于从集群中删除一个节点。

- `192.168.122.139:7008`: 想要删除节点所在的Redis服务器地址和端口号。

- `52f908ae0c8e74f7375a679b6bad3250bd018f86`: 想要从集群中删除的节点的ID。

```shell
[root@redis-7001 ~]# redis-cli -a root --cluster del-node 192.168.122.139:7008 52f908ae0c8e74f7375a679b6bad3250bd018f86
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
>>> Removing node 52f908ae0c8e74f7375a679b6bad3250bd018f86 from cluster 192.168.122.139:7008
>>> Sending CLUSTER FORGET messages to the cluster...
>>> Sending CLUSTER RESET SOFT to the deleted node.
```

### 再次检查集群情况

Redis集群已经变成了4主3从

```shell
[root@redis-7001 ~]# redis-cli -a root --cluster check 192.168.122.132:7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
192.168.122.132:7001 (19ebecba...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.134:7003 (e49ab26e...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.133:7002 (318bf90e...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.138:7007 (c2e3aa09...) -> 1 keys | 4096 slots | 0 slaves.
[OK] 4 keys in 4 masters.
0.00 keys per slot on average.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[1365-5460] (4096 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 192.168.122.138:7007
   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

## 将master7007的槽位清空并重新分配给7001

7001的节点ID：19ebecba98d2e33ba184d396e630a9e6434e4196

7007的节点ID：c2e3aa097b500f6e81eafb2cb6f60d68fe726e98

```shell
[root@redis-7001 ~]# redis-cli -a root --cluster reshard 192.168.122.132:7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[1365-5460] (4096 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
M: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 192.168.122.138:7007
   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
How many slots do you want to move (from 1 to 16384)? 4096
What is the receiving node ID? 
```

接收槽位的7001节点ID：19ebecba98d2e33ba184d396e630a9e6434e4196

```shell
What is the receiving node ID? 19ebecba98d2e33ba184d396e630a9e6434e4196
Please enter all the source node IDs.
  Type 'all' to use all the nodes as source nodes for the hash slots.
  Type 'done' once you entered all the source nodes IDs.
Source node #1: 
```

这里就不能直接填all，输入提供槽位的7007节点ID：c2e3aa097b500f6e81eafb2cb6f60d68fe726e98

```shell
Source node #1: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
Source node #2: done
```

接下来依旧是yes，按照提出的reshard计划进行操作

```shell
    ......
    Moving slot 12282 from c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
    Moving slot 12283 from c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
    Moving slot 12284 from c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
    Moving slot 12285 from c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
    Moving slot 12286 from c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
    Moving slot 12287 from c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
Do you want to proceed with the proposed reshard plan (yes/no)? yes
```

### 查看集群情况

7007将4096个槽位都分给了7001,7001共有8192个槽位。

master7007变为了slave7001，它的master是7001

```shell
[root@redis-7001 ~]# redis-cli -a root --cluster check 192.168.122.132:7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
192.168.122.132:7001 (19ebecba...) -> 2 keys | 8192 slots | 2 slaves.
192.168.122.134:7003 (e49ab26e...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.133:7002 (318bf90e...) -> 1 keys | 4096 slots | 1 slaves.
[OK] 4 keys in 3 masters.
0.00 keys per slot on average.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[0-6826],[10923-12287] (8192 slots) master
   2 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
S: c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 192.168.122.138:7007
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

## Redis集群删除从节点7007

```shell
[root@redis-7001 ~]# redis-cli -a root --cluster del-node 192.168.122.138:7007 c2e3aa097b500f6e81eafb2cb6f60d68fe726e98
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
>>> Removing node c2e3aa097b500f6e81eafb2cb6f60d68fe726e98 from cluster 192.168.122.138:7007
>>> Sending CLUSTER FORGET messages to the cluster...
>>> Sending CLUSTER RESET SOFT to the deleted node.
```

### 查看集群情况

Redis集群恢复到了3主3从

```shell
[root@redis-7001 ~]# redis-cli -a root --cluster check 192.168.122.132:7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
192.168.122.132:7001 (19ebecba...) -> 2 keys | 8192 slots | 1 slaves.
192.168.122.134:7003 (e49ab26e...) -> 1 keys | 4096 slots | 1 slaves.
192.168.122.133:7002 (318bf90e...) -> 1 keys | 4096 slots | 1 slaves.
[OK] 4 keys in 3 masters.
0.00 keys per slot on average.
>>> Performing Cluster Check (using node 192.168.122.132:7001)
M: 19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001
   slots:[0-6826],[10923-12287] (8192 slots) master
   1 additional replica(s)
S: d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004
   slots: (0 slots) slave
   replicates e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663
M: e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003
   slots:[12288-16383] (4096 slots) master
   1 additional replica(s)
S: 9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005
   slots: (0 slots) slave
   replicates 19ebecba98d2e33ba184d396e630a9e6434e4196
S: 21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006
   slots: (0 slots) slave
   replicates 318bf90e3c9922aadf8e72734c86a75fd1ab571d
M: 318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002
   slots:[6827-10922] (4096 slots) master
   1 additional replica(s)
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```



# 不在同一个slot槽位下的批处理命令操作支持不好

使用mset、mget命令都报错：(error) CROSSSLOT Keys in request don't hash to the same slot

```shell
[root@redis-7001 ~]# redis-cli -a root -p 7001 -c
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7001> mset k1 v1 k2 v2 k3 v3
(error) CROSSSLOT Keys in request don't hash to the same slot
127.0.0.1:7001> set k1 v1
-> Redirected to slot [12706] located at 192.168.122.134:7003
OK
192.168.122.134:7003> set k2 v2
-> Redirected to slot [449] located at 192.168.122.132:7001
OK
192.168.122.132:7001> set k3 v3
OK
192.168.122.132:7001> mget k1 k2 k3
(error) CROSSSLOT Keys in request don't hash to the same slot
192.168.122.132:7001> get k1
-> Redirected to slot [12706] located at 192.168.122.134:7003
"v1"
192.168.122.134:7003> get k2
-> Redirected to slot [449] located at 192.168.122.132:7001
"v2"
192.168.122.132:7001> get k3
"v3"
```

不在同一个slot槽位下的键值无法使用mset、mget等批处理操作。



可以通过哈希标签{}来定义同一个组的概念，使key中{}内相同内容的键值对放到一个slot槽位去。

当使用 `{...}` 模式时，Redis 会提取 `{...}` 中的内容，并计算这个内容的哈希值。然后，这个哈希值会被用来决定键应该属于哪个槽位，而不是对整个键名进行哈希。这确保了包含相同 `{...}` 内容的键会被分配到同一个槽位上。

例如，对于键 `k1{x}`、`k2{x}` 和 `k3{x}`，Redis 会提取出 `{x}`，并仅对x进行哈希计算,那么这三个键将会映射到相同的槽位上。

```shell
192.168.122.134:7001> mset k1{x} v1 k2{x} v2 k3{x} v3
OK
192.168.122.134:7003> mget k1{x} k2{x} k3{x}
1) "v1"
2) "v2"
3) "v3"

```

这种特殊处理是在 Redis 集群的键哈希函数 `keyHashSlot` 中实现的。这个函数负责将键名映射到一个具体的槽位上。当检测到键名中包含 `{...}` 时，它会提取出大括号中的内容，并仅对这个子字符串进行哈希计算。

对于不包含 `{...}` 的键名，Redis 会对整个键名进行 CRC16 哈希计算，并根据结果将其映射到一个槽位上。

![image-20240307163400582](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403071634275.png)





# 集群常用命令

## cluster-require-full-coverage

现在集群架构是3主3从。redis cluster由3个master平分16384个slot，每个master的主从架构负责1/3的slot，对应一部分数据。

cluster-require-full-coverage：默认值yes，即需要集群完整性，才可以对外提供服务。

如果这3个小集群中，任何一个（1主1从）挂了，你这个集群对外可提供的数据只有2/3了，整个集群是不完整的，redis 默认在这种情况下，是不会对外提供服务的。

如果你的诉求是,集群不完整的话也需要对外提供服务,需要将该参数设置为no,这样的话你挂了的那个小集群是不行了,但是其他的小集群仍然可以对外提供服务。

## CLUSTER COUNTKEYSINSLOT 槽位数字编号

查看指定槽位 `<slot>` 目前包含的键值对数量。这个命令只在执行它的节点上进行计数，如果指定的槽位并不属于该节点处理，那么将找不到任何属于该槽位的键，并返回0作为结果。

```shell
192.168.122.134:7003> get k3
-> Redirected to slot [4576] located at 192.168.122.132:7001
"v3"
192.168.122.132:7001> CLUSTER COUNTKEYSINSLOT 4576
(integer) 1
192.168.122.132:7001> get k1
-> Redirected to slot [12706] located at 192.168.122.134:7003
"v1"
192.168.122.134:7003> CLUSTER COUNTKEYSINSLOT 12706
(integer) 1
192.168.122.134:7003> CLUSTER COUNTKEYSINSLOT 4576
(integer) 0
```

## CLUSTER KEYSLOT 键名称

查看指定键（`<key>`）所属的槽位。

```shell
192.168.122.134:7003> CLUSTER KEYSLOT k1
(integer) 12706
192.168.122.134:7003> CLUSTER KEYSLOT k3
(integer) 4576
```

## CLUSTER NODES

列出集群中所有节点的信息。这些信息包括每个节点的ID、IP地址和端口号，以及它们的状态（例如，是主节点还是从节点），与其他节点的连接情况，负责的槽位范围等。

```shell
192.168.122.134:7003> cluster nodes
318bf90e3c9922aadf8e72734c86a75fd1ab571d 192.168.122.133:7002@17002 master - 0 1709802179000 2 connected 6827-10922
21e92cb603e3456bb1cb49dc3ab668978ef1f22f 192.168.122.137:7006@17006 slave 318bf90e3c9922aadf8e72734c86a75fd1ab571d 0 1709802180000 2 connected
d341462815d05806cf27bdfe2627af3a05fccfc8 192.168.122.135:7004@17004 slave e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 0 1709802179643 3 connected
e49ab26e91fd5b8a726bc1e4a79cf0f6de2fd663 192.168.122.134:7003@17003 myself,master - 0 1709802178000 3 connected 12288-16383
9c35d6afa7ba4b161864a71b1c6bad9e4d1d62ff 192.168.122.136:7005@17005 slave 19ebecba98d2e33ba184d396e630a9e6434e4196 0 1709802179040 12 connected
19ebecba98d2e33ba184d396e630a9e6434e4196 192.168.122.132:7001@17001 master - 0 1709802179000 12 connected 0-6826 10923-12287
```



























