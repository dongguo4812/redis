SpringBoot + Mybatis + Redis实现用户信息数据库与缓存的增删改查。

# 数据库创建t_user表

```sql
CREATE TABLE `t_user` (
  `id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,
  `username` VARCHAR(50) NOT NULL DEFAULT '' COMMENT '用户名',
  `password` VARCHAR(50) NOT NULL DEFAULT '' COMMENT '密码',
  `sex` TINYINT(4) NOT NULL DEFAULT '0' COMMENT '性别 0=女 1=男 ',
  `deleted` TINYINT(4) UNSIGNED NOT NULL DEFAULT '0' COMMENT '删除标志，默认0不删除，1删除',
  `update_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `create_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`)
) ENGINE=INNODB AUTO_INCREMENT=1001 DEFAULT CHARSET=utf8 COMMENT='用户表';
 
SELECT * FROM t_user;
```

# mybatis-generator一键生成生成entity+mapper

[mybatis-generator](https://github.com/dongguo4812/mybatis-generator)

## 1.创建包

创建com.dongguo包

## 2.配置项

```properties
#t_customer表包名
package.name=com.dongguo

jdbc.driverClass=com.mysql.cj.jdbc.Driver
jdbc.url=jdbc:mysql://localhost:3306/mybatis_generator?useSSL=false&serverTimezone=UTC&nullCatalogMeansCurrent=true
jdbc.user=root
jdbc.password=root
```

## 3.代码生成

使用**mybatis-generator项目**双击插件mybatis-generator:gererate，一键生成entity+mapper接口

![image-20240309151507692](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403091515694.png)

在com.donguo.entity包下生成User类，

在com.donguo.mapper包下生成UserMapper类和UserMapper.xml

# SpringBoot + Mybatis + Redis缓存实战

还是使用redis_client项目

## 1.pom引入数据库相关依赖

```xml
        <!--mybatis和springboot整合-->
        <dependency>
            <groupId>org.mybatis.spring.boot</groupId>
            <artifactId>mybatis-spring-boot-starter</artifactId>
        </dependency>
        <!--SpringBoot集成druid连接池-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid-spring-boot-starter</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
        </dependency>
        <!--Mysql数据库驱动-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <!--通用Mapper-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper</artifactId>
        </dependency>
```

## 2.application.yml增加数据库配置

```yml
spring: 
  data:
    redis:
      host: 192.168.122.131
      port: 6379
      password: root
# ========================alibaba.druid相关配置=====================
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/redis?useUnicode=true&characterEncoding=utf-8&useSSL=false
    username: root
    password: root
    druid:
      test-while-ide: false
# ========================mybatis相关配置===================
mybatis:
  mapper-location: classpath:mapper/*.xml
  type-aliases-package: com.dongguo.redis.entity      
```



## 3.主启动类添加包扫描路径

```java
@SpringBootApplication
@MapperScan("com.dongguo.redis.mapper") //import tk.mybatis.spring.annotation.MapperScan;
public class SpringbootRedisApplication {
    public static void main(String[] args) {
        SpringApplication.run(SpringbootRedisApplication.class, args);
        System.out.println("http://127.0.0.1:9000/swagger-ui/index.html");
    }
}
```

## 4.将一键生成生成entity+mapper接口+xml拷贝到项目中，entity加入swagger注解

```java
import io.swagger.v3.oas.annotations.media.Schema;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.Column;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

@Schema(title = "用户表", description = "用户表")
@Table(name = "t_user")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class User {
    @Id
    @GeneratedValue(generator = "JDBC")
    @Schema(name = "ID", description = "ID")
    private Long id;

    /**
     * 用户名
     */
    @Schema(name = "用户名", description = "用户名")
    private String username;

    /**
     * 密码
     */
    @Schema(name = "密码", description = "密码")
    private String password;

    /**
     * 性别 0=女 1=男 
     */
    @Schema(name = "性别", description = "性别 0=女 1=男")
    private Byte sex;

    /**
     * 删除标志，默认0不删除，1删除
     */
    @Schema(name = "删除标志", description = "删除标志，默认0不删除，1删除")
    private Byte deleted;

    /**
     * 更新时间
     */
    @Schema(name = "更新时间", description = "更新时间")
    @Column(name = "update_time")
    private Date updateTime;

    /**
     * 创建时间
     */
    @Schema(name = "创建时间", description = "创建时间")
    @Column(name = "create_time")
    private Date createTime;
}
```



```java
import io.swagger.v3.oas.annotations.media.Schema;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;
import java.util.Date;
@Data
@NoArgsConstructor
@AllArgsConstructor
@Schema(title = "用户信息", description = "用户信息")
public class UserBO implements Serializable {
    @Schema(name = "id", description = "ID")
    private Long id;

    @Schema(name = "username", description = "用户名")
    private String username;

    @Schema(name = "password", description = "密码")
    private String password;

    @Schema(name = "sex", description = "性别 0=女 1=男")
    private Byte sex;

    @Schema(name = "deleted", description = "删除标志，默认0不删除，1删除")
    private Byte deleted;

    @Schema(name = "updateTime", description = "更新时间")
    private Date updateTime;

    @Schema(name = "createTime", description = "创建时间")
    private Date createTime;
}
```



## 5.实现增删改查方法，并加入缓存

UserService：

```java
import com.dongguo.redis.entity.User;
import com.dongguo.redis.mapper.UserMapper;
import com.dongguo.redis.utils.CacheKeyUtil;
import jakarta.annotation.Resource;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import java.util.concurrent.TimeUnit;

@Service
public class UserService {


    @Resource
    private UserMapper userMapper;

    @Resource
    private RedisTemplate redisTemplate;

    public void addUser(User user) {
        int count = userMapper.insertSelective(user);
        if (count > 0) {
            String Key = CacheKeyUtil.CACHE_KEY_USER + user.getId();
            redisTemplate.opsForValue().set(Key, user);
        }
    }

    public void deleteUser(Long id) {
        int count = userMapper.deleteByPrimaryKey(id);
        if (count > 0) {
            String Key = CacheKeyUtil.CACHE_KEY_USER + id;
            redisTemplate.delete(Key);
        }
    }

    public void editUser(User user) {
        User oldUser = userMapper.selectByPrimaryKey(user);
        if (null == oldUser) {
            return;
        }
        int count = userMapper.updateByPrimaryKey(user);
        if (count > 0) {
            String Key = CacheKeyUtil.CACHE_KEY_USER + user.getId();
            redisTemplate.delete(Key);
        }

    }

    public User findUser(Long id) {
        String Key = CacheKeyUtil.CACHE_KEY_USER + id;
        User user = (User) redisTemplate.opsForValue().get(Key);
        if (null == user) {
            user = userMapper.selectByPrimaryKey(id);
            if (null == user) {
                return null;
            }
            redisTemplate.opsForValue().set(Key, user, 1000, TimeUnit.MINUTES);
        }
        return user;
    }
}
```

controller

```java
import com.dongguo.redis.entity.User;
import com.dongguo.redis.entity.UserBO;
import com.dongguo.redis.service.UserService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.annotation.Resource;
import org.springframework.beans.BeanUtils;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/user")
@Tag(
        name = "UserController",
        description = "用户控制器接口")
public class UserController {
    @Resource
    private UserService userService;

    /***
     * 根据ID查询用户信息（单条）
     * @param id 用户ID
     * @return 返回一条数据
     */
    @Operation(
            summary = "根据Id查询用户信息",
            description = "根据ID查询用户信息，并返回响应结果信息",
            parameters = {
                    @Parameter(name = "id", description = "用户ID", required = true, example = "1")
            }
    )
    @GetMapping("/findUser/{id}")
    public User findUser(@PathVariable(value = "id") Long id) {
        return userService.findUser(id);
    }

    /***
     * 新增用户信息（单条）
     */
    @Operation(
            summary = "新增用户信息",
            description = "新增用户信息"
    )
    @PostMapping("/addUser")
    public void addUser(@RequestBody UserBO userBO) {
        User user = new User();
        BeanUtils.copyProperties(userBO, user);
        userService.addUser(user);
    }

    /***
     * 删除用户信息（单条）
     */
    @Operation(
            summary = "删除用户信息",
            description = "删除用户信息"
    )
    @PostMapping("/deleteUser/{id}")
    public void deleteUser(@PathVariable(value = "id") Long id) {
        userService.deleteUser(id);
    }

    /***
     * 编辑用户信息（单条）
     */
    @Operation(
            summary = "编辑用户信息",
            description = "编辑用户信息"
    )
    @PostMapping("/editUser")
    public void editUser(@RequestBody UserBO userBO) {
        User user = new User();
        BeanUtils.copyProperties(userBO, user);
        userService.editUser(user);
    }
}
```

**6.访问swagger**

http://127.0.0.1:8080/swagger-ui/index.html

![image-20240309170948262](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403091709909.png)

## 6.测试

新增用户

```json
{
  "id": 2,
  "username": "李四",
  "password": "123",
  "sex": "0",
  "deleted": "0",
  "updateTime": "2024-02-24T10:07:31.445Z",
  "createTime": "2024-02-24T10:07:31.445Z"
}
```

