# 微信文章阅读量统计

![QQ浏览器截图20240309214040](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403092144351.png)

## 用户阅读文章贡献一个阅读量

分析：使用string的incr实现增加阅读量。

ArticleService：

```java
import jakarta.annotation.Resource;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;
import static com.dongguo.redis.utils.CacheKeyUtil.CACHE_ARTICLE_KEY;

@Slf4j
@Service
public class ArticleService {
    @Resource
    private RedisTemplate redisTemplate;

    public void addReading(String articleId) {
        String key = CACHE_ARTICLE_KEY + articleId;
        Long number = redisTemplate.opsForValue().increment(key);
        log.info("文章编号:{}, 阅读量:{}", articleId, number);
    }


    public Integer getReading(String articleId) {
        String key = CACHE_ARTICLE_KEY + articleId;
        Object obj = redisTemplate.opsForValue().get(key);
        log.info("文章编号:{}, 阅读量:{}", articleId, obj == null ? 0 : obj);
        return (Integer) obj;
    }
}

```



```java
import com.dongguo.redis.service.ArticleService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.annotation.Resource;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/article")
@Tag(
        name = "ArticleController",
        description = "文章控制器接口")
public class ArticleController {

    @Resource
    private ArticleService articleService;

    @Operation(
            summary = "需求1.0:增加阅读量",
            description = "用户阅读文章贡献一个阅读量"
    )
    @PostMapping("/addReading/{articleId}")
    public void addReading(@PathVariable(value = "articleId") String articleId) {
        articleService.addReading(articleId);
    }

    @Operation(
            summary = "获取阅读量",
            description = "获取阅读量"
    )
    @PostMapping("/getReading/{articleId}")
    public Integer getReading(@PathVariable(value = "articleId") String articleId) {
        return articleService.getReading(articleId);
    }
}

```



## 同篇文章一个微信号只能贡献一个阅读量

这时候产品经理告诉你，之前需求有问题，一个微信号可以无限制的增加文章的阅读量，要求进行修改。

分析：一篇文章一个微信号只能增加一次阅读量，使用set保存该文章贡献阅读量的微信号id，如果未阅读过该篇文章，就增加一次阅读量

ArticleService：

```java
    public void addReadingOnlyOnce(String articleId, String weChatId) {
        String key = CACHE_ARTICLE_KEY + articleId;
        String weChatKey = CACHE_WECHAT_KEY + articleId + ":" + weChatId;
        Boolean member = redisTemplate.opsForSet().isMember(weChatKey, weChatId);
        if (Boolean.FALSE.equals(member)) {
            Long number = redisTemplate.opsForValue().increment(key);
            log.info("文章编号:{}, 阅读量:{}", articleId, number);
            redisTemplate.opsForSet().add(weChatKey, weChatId);
        }
    }
```

ArticleController：

```java
    @Operation(
            summary = "需求2.0:增加阅读量",
            description = "同篇文章一个微信号只能贡献一个阅读量"
    )
    @PostMapping("/addReadingOnlyOnce")
    public void addReadingOnlyOnce(@RequestParam(value = "articleId") String articleId, @RequestParam(value = "weChatId") String weChatId) {
        articleService.addReadingOnlyOnce(articleId, weChatId);
    }
```



## 同篇文章一个微信号每天只能贡献一次阅读量

不久后产品经理又改需求，一个微信号可以无限制的增加文章的阅读量，那文章的阅读量太少了，要求进行修改。

改成同篇文章一个微信号每天只能贡献一次阅读量，隔天可以再贡献一次阅读量。

分析：使用set保存该文章贡献阅读量的微信号id，并设置过期时间为隔天零点。当天未阅读过该篇文章，就增加一次阅读量

ArticleService：

```java
    public void addReadingOnlyOnceOfDay(String articleId, String weChatId) {
        String key = CACHE_ARTICLE_KEY + articleId;
        String weChatKey = CACHE_WECHAT_KEY + articleId + ":" +  weChatId;
        Boolean hasKey = redisTemplate.hasKey(weChatKey);
        Boolean member = redisTemplate.opsForSet().isMember(weChatKey, weChatId);
        if (Boolean.FALSE.equals(member)) {
            Long number = redisTemplate.opsForValue().increment(key);
            log.info("文章编号:{}, 阅读量:{}", articleId, number);
            redisTemplate.opsForSet().add(weChatKey, weChatId);
            //当该key第一次赋值时设置过期时间为明天0点,可以使用定时任务
            if (Boolean.FALSE.equals(hasKey)) {
                // 获取当前日期
                Date today = new Date();
                // 获取明天的日期
                Date tomorrow = DateUtil.offsetDay(today, 1);
                // 获取明天凌晨的日期时间（0点）
                Date tomorrowMidnight = DateUtil.beginOfDay(tomorrow);
                redisTemplate.expireAt(weChatKey, tomorrowMidnight);
            }
        }
    }
```

ArticleController：

```java
    @Operation(
            summary = "需求3.0:增加阅读量",
            description = "同篇文章一个微信号每天只能贡献一次阅读量"
    )
    @PostMapping("/addReadingOnlyOnceOfDay")
    public void addReadingOnlyOnceOfDay(@RequestParam(value = "articleId") String articleId, @RequestParam(value = "weChatId") String weChatId) {
        articleService.addReadingOnlyOnceOfDay(articleId, weChatId);
    }
```

