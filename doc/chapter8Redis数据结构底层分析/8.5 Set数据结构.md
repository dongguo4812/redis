Redis用intset或hashtable存储set。

当存储的所有数据都是整数，并且元素数量不超过set-max-intset-entries时，Set会采用IntSet编码，以节省内存

如果不是整数类型，就用hashtable（数组+链表的存来储结构）。key就是元素的值，value为null。

![image-20240318204959571](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110469.png)

# IntSet

Intset是reids中set集合的一种实现方式，基于整数数组来实现，并且具备长度可变，有序等特征。

![image-20240327102222550](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271022911.png)

其中的encoding包含三种模式，表示存储的整数大小

![image-20240327102623589](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271026808.png)

为了方便查找，redis将inset中所有的整数按照升序一次保存在contents数组中，结构如图：

![image-20240327103455586](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271034642.png)

数组中每个数字都在int16_t的范围内，因此采用的编码方式是INTSET_ENC_INT16，每部分占用的字节大小为：

encoding：4字节

length：4字节

contents： 2字节*3 =6字节



查找元素公式 startPtr + (sizeof(int16) * index)

即 起始内存地址 + （占用的字节长度 * 角标）

## IntSet动态升级

假设有一个intset，元素为{5,10,20}，采用的编码是INTSET_ENC_INT16，则每个整数占2个字节。

![image-20240327103930233](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271039398.png)

我们向其中添加一个数字：5000，这个数字超出了int16_t的范围，intset会自动升级编码方式到合适的大小。

升级流程细：

1.升级编码为INTSET_ENC_INT32，每个整数占4个字节，并按照新的编码方式及元素个数扩容数组。

![image-20240327104330186](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271044282.png)

2.倒序依次将数组中的元素拷贝到扩容后的正确为止

移动20

![](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271044871.png)

移动10

![image-20240327104456935](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271045112.png)

移动5

![image-20240327104528371](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271045986.png)

3.将待添加的元素放入数组末尾

![image-20240327104606347](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271046498.png)

4.最终，将intset的encoding属性改为INTSET_ENC_INT32

![image-20240327104722518](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271047570.png)

## 源码

intset.c 

![image-20240327105743216](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271057696.png)

添加元素触发扩容升级

![image-20240327105603917](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271056679.png)

查找是否存在重复值  二分查找

![image-20240327105841068](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271058718.png)

![image-20240327110002561](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271100308.png)









![image-20240318205159397](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110538.png)

![image-20240318205221282](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110831.png)

t_set.c

![image-20240318205107308](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110466.png)

![image-20240318205228863](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110892.png)