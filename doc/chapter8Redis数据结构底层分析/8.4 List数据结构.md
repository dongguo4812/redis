Redis的List结构类似一个双端链表，可以从首、尾操作列表中的元素：

![image-20240327144522784](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271445005.png)

在3.2版本之前，Redis采用ZipList和LinkedList来实现List，当元素数量小于512并且元素大小小于64字节时采用ZipList编码，超过则采用LinkedList编码。

在3.2版本之后，Redis统一采用QuickList来实现List：

![image-20240318194922889](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110514.png)



![image-20240318194934367](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110747.png)

# Redis6 QuickList



![image-20240318195400753](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110056.png)



(1) ziplist中entry配置：list-max-ziplist-size -2

为了避免QuickList中的每个ziplist中entry过多，redis提供了一个配置项list-max-ziplist-size来限制

  当取正值的时候，表示按照数据项个数来限定每个quicklist节点上的ziplist长度。比如，当这个参数配置成5的时候，表示每个quicklist节点的ziplist最多包含5个数据项。当取负值的时候，表示按照占用字节数来限定每个quicklist节点上的ziplist长度。这时，它只能取-1到-5这五个值，

每个值含义如下：

-5: 每个quicklist节点上的ziplist大小不能超过64 Kb。（注：1kb => 1024 bytes）

-4: 每个quicklist节点上的ziplist大小不能超过32 Kb。

-3: 每个quicklist节点上的ziplist大小不能超过16 Kb。

-2: 每个quicklist节点上的ziplist大小不能超过8 Kb。（-2是Redis给出的默认值）

-1: 每个quicklist节点上的ziplist大小不能超过4 Kb。

(2) ziplist压缩配置：list-compress-depth 0

除了控制ziplist的大小，quicklist还可以对节点的ziplist做压缩。因为链表一般都是从首位访问较多，所以首位是不压缩的，

参数list-compress-depth的取值含义如下：

0: 是个特殊值，表示都不压缩。这是Redis的默认值。

1: 表示quicklist两端各有1个节点不压缩，中间的节点压缩。

2: 表示quicklist两端各有2个节点不压缩，中间的节点压缩。

3: 表示quicklist两端各有3个节点不压缩，中间的节点压缩。

依此类推…

![image-20240318195506271](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110557.png)

list用quicklist来存储，quicklist就是「双向链表 + 压缩列表」组合，因为一个 quicklist 就是一个双向链表，而链表中的每个节点都是一个压缩列表ziplist

ziplist的优点是内存紧凑，访问效率高，缺点是更新效率低，并且数据量较大时，可能导致大量的内存复制

linkedlist 的优点是节点修改的效率高，但是需要额外的内存开销，并且节点较多时，会产生大量的内存碎片

为了结合两者的优点，在 redis 3.2之后，list 的底层实现变为快速列表quicklist。

![image-20240327141841504](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271418441.png)



## 源码

quicklist.h

quicklist的head和tail指向双向列表的表头和表尾

![image-20240327142447457](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271424772.png)

quicklist由一个个quicklistNode组成

quicklistNode中的*zl指向一个ziplist， 一个ziplist可以存放多个元素 

![image-20240327142431891](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403271424026.png)

我们接下来用一段流程图来描述当前的这个结构

![image-20240318201147622](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110621.png)

# redis7 QuickList

![image-20240318201202135](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182110922.png)

listpack用来替代ziplist，在redis7中已经没有ziplist的配置，为了兼容和过渡，依然保留ziplist的配置。



## 源码

### t_list.c

![image-20240318204538852](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182109707.png)



object.c

![image-20240318204623631](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403182109660.png)





















