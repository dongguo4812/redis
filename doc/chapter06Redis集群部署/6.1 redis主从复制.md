单节点Redis的并发能力是有上限的，要进一步提高Redis的并发能力，就需要搭建主从模式，实现读写分离。

主从复制也叫主从模式，当用户往Master端写入数据时，通过Redis Sync机制将数据文件发送至Slave，Slave也会通过Redis Sync机制将数据文件发送至Master以确保数据一致，来实现Redis的主从复制。如果Master和Slave之间的链接出现断连现象，Slave可以自动重连Master，但是在连接成功之后，一次完全同步将被自动执行。

在主从复制配置后，Master（主节点）可以负责读写服务，Slave（从节点）只负责读服务。Redis复制在Master 这一端是非阻塞的，也就是说在和Slave 同步数据的时候，Master仍然可以执行客户端的操作命令而不受其影响

# 作用

- 读写分离
- 容灾恢复
- 数据备份
- 水平扩容支撑高并发

# 相关细节

## 1.配置从库

主从复制只需要配置从库即可，不用配置主库

## 2.权限细节

master如果配置了requirepass密码参数，需要密码登录。

那么slave就要配置masterauth来设置校验密码，否则master会拒绝slave的访问请求

## 3.操作命令

### info  replication

查看复制节点的主从关系和配置信息

### replicaof 主库ip 主库端口

指定主库，一般在redis.conf配置文件中配置

### slaveof 主库ip 主库端口

`replicaof` 和 `slaveof` 都是用来配置从服务器（slave）追踪主服务器（master）的命令。不过，`slaveof` 是早期Redis版本中的命令，而 `replicaof` 是在较新的版本中引入的，作为 `slaveof` 的替代品。

从Redis 6开始，`slaveof` 命令已被弃用，并推荐使用 `replicaof` 命令来配置主从复制。

### slaveof no one

使当前数据库停止与其他数据库的同步，转成主数据库（单机）

# 搭建主从架构

![image-20240305141100882](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403051411833.png)

本次主从架构共包含三个节点，一个主节点，两个从节点。

三台虚拟机对应3个redis实例，模拟主从集群，信息如下：

| IP              | PORT | 角色   |
| --------------- | ---- | ------ |
| 192.168.122.132 | 7001 | master |
| 192.168.122.133 | 7002 | slave  |
| 192.168.122.134 | 7003 | slave  |

三个redis实例都是从Redis环境搭建时虚拟机拷贝来的。



在配置之前要确保三台机器能够互相ping通

## 通用配置

这里只展示了master的配置，slave配置适当修改即可

1.关闭redis的开机自启

```shell
[root@redis-7001 opt]# systemctl disable redis
Removed symlink /etc/systemd/system/multi-user.target.wants/redis.service.
```

2.将redis.conf拷贝为redis7001.conf，剩下两个对应端口即可

```shell
[root@redis-7001 opt]# cd /opt/redis-6.2.6
[root@redis-7001 redis-6.2.6]# cp redis.conf redis7001.conf
```

## 配置master

修改redis7001.conf配置

1. daemonize yes  #开启守护进程模式，Redis在后台运行
2. bind  0.0.0.0    #也可以注掉
3. port 7001  #指定端口
4. dir /myredis  #指定当前工作目录
5. pidfile /var/run/redis_7001.pid  #PID写入的文件目录
6. logfile "/myredis/redis.log"   #日志文件地址
7. requirepass  root  #密码
8. dbfilename dump7001.rdb   #RDB文件，为区分可加端口号进行区分，也可以不改 

## 配置slave

修改redis7002.conf配置，slave7003配置适当修改即可

1. daemonize yes  #开启守护进程模式，Redis在后台运行
2. bind  0.0.0.0    #也可以注掉
3. port 7001  #指定端口
4. dir /myredis  #指定当前工作目录
5. pidfile /var/run/redis_7002.pid  #PID写入的文件目录
6. logfile "/myredis/redis.log"   #日志文件地址
7. requirepass  root  #密码
8. dbfilename dump7002.rdb   #RDB文件，为区分可加端口号进行区分，也可以不改 
9. masterauth root #若master主机设置了密码  slave从机必须配置masterauth
10. replicaof 192.168.122.132 7001  #指定master的ip 端口

## 启动redis

master7001

```shell
[root@redis-7001 redis-6.2.6]# redis-server /opt/redis-6.2.6/redis7001.conf 
[root@redis-7001 redis-6.2.6]# redis-cli -a root -p 7001
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7001> 
```

slave7002

```shell
[root@redis-7002 redis-6.2.6]# redis-server /opt/redis-6.2.6/redis7002.conf 
[root@redis-7002 redis-6.2.6]# redis-cli -a root -p 7002
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7002> 
```

slave7003

```shell
[root@redis-7003 redis-6.2.6]# redis-server /opt/redis-6.2.6/redis7003.conf 
[root@redis-7003 redis-6.2.6]# redis-cli -a root -p 7003
Warning: Using a password with '-a' or '-u' option on the command line interface may not be safe.
127.0.0.1:7003> 
```

## 主从关系查看

查看master的日志

