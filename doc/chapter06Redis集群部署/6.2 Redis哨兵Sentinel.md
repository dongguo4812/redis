# 思考

Redis主从架构，slave节点宕机恢复后可以找master节点同步数据，那么master节点宕机怎么办？

主从集群下，无法自动进行主从切换，master节点挂掉，该主从集群无法执行写操作，只能执行读操作。

引出哨兵：

使用哨兵Sentinel监控master是否故障，如果故障了根据投票数选举自动将某一个从库转换成新主库，继续对外服务。

# Redis哨兵

Redis提供了哨兵（Sentinel）机制来实现主从集群的自动故障恢复。

## 作用

- 监控：Sentinel 会不断检查您的master和slave是否正常工作，监控Redis的运行状态。

- 自动故障转移：当master宕机后，实现故障转移，自动将slave切换成新的master。当故障实例回复后会切换成slave以新的master为主。

- 消息通知：当集群发生故障转移时，Sentinel会将故障转移的结果噶送给所有连接到它的Redis客户端。

- 配置中心：提供和维护集群的配置信息，如节点地址、角色等。确保客户端能够正确地连接到Redis节点

# 搭建哨兵集群

![image-20240306121019675](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403061210935.png)

这里我们搭建一个三个节点形成的Sentinel集群，来监管之前的Redis主从集群。

三个sentinel实现自动监控和维护集群，不存放数据

实例信息如下：

以192.168.122.132实例克隆出三个新的实例

| 节点     | IP              |
| -------- | --------------- |
| sentine1 | 192.168.122.135 |
| sentine2 | 192.168.122.136 |
| sentine3 | 192.168.122.137 |



这里只以sentine1为例

## sentinel.conf做备份

```shell
[root@sentinel1 ~]# cd /opt/redis-6.2.6
[root@sentinel1 redis-6.2.6]# ll
总用量 428
-rw-rw-r--.  1 root root 33624 10月  4 2021 00-RELEASENOTES
-rw-rw-r--.  1 root root    51 10月  4 2021 BUGS
-rw-rw-r--.  1 root root  5026 10月  4 2021 CONDUCT
-rw-rw-r--.  1 root root  3384 10月  4 2021 CONTRIBUTING
-rw-rw-r--.  1 root root  1487 10月  4 2021 COPYING
drwxrwxr-x.  7 root root   213 3月   5 15:23 deps
-rw-rw-r--.  1 root root    11 10月  4 2021 INSTALL
-rw-rw-r--.  1 root root   151 10月  4 2021 Makefile
-rw-rw-r--.  1 root root  6888 10月  4 2021 MANIFESTO
-rw-rw-r--.  1 root root 21567 10月  4 2021 README.md
-rw-r--r--.  1 root root 93795 3月   5 16:56 redis7001.conf
-rw-rw-r--.  1 root root 93791 3月   5 15:38 redis.conf
-rw-r--r--.  1 root root 93724 3月   5 15:26 redis.conf.bak
-rwxrwxr-x.  1 root root   275 10月  4 2021 runtest
-rwxrwxr-x.  1 root root   279 10月  4 2021 runtest-cluster
-rwxrwxr-x.  1 root root  1079 10月  4 2021 runtest-moduleapi
-rwxrwxr-x.  1 root root   281 10月  4 2021 runtest-sentinel
-rw-rw-r--.  1 root root 13768 10月  4 2021 sentinel.conf
drwxrwxr-x.  3 root root 12288 3月   5 15:24 src
drwxrwxr-x. 11 root root   182 10月  4 2021 tests
-rw-rw-r--.  1 root root  3055 10月  4 2021 TLS.md
drwxrwxr-x.  9 root root  4096 10月  4 2021 utils
[root@sentinel1 redis-6.2.6]# cp sentinel.conf sentinel.conf.bak
```

## sentinel.conf重要参数说明

- bind：服务监听地址，用于客户端连接，默认本机地址
- daemonize：是否以后台方式运行。
- protected-mode：是否开启安全保护模式
- port:端口号
- logfile:日志文件路径
- pidfile: pid文件路径

- dir: 工作目录

- sentinel monitor <master-name> <ip> <redis-port> <quorum>:设置要监控的master服务器，quorum表示确认客观下线的最少的哨兵数量，统一故障迁移的法定票数。

我们知道，网络是不可靠的，有时候一个sentinel会因为网络堵塞而误以为一个master redis已经死掉了，在sentinel集群环境下需要多个sentinel互相沟通来确认某个master是否真的死了，quorum这个参数是进行客观下线的一个依据，意思是至少有quorum个sentinel认为这个master有故障，才会对这个master进行下线以及故障转移。因为有的时候，某个sentinel节点可能因为自身网络原因，导致无法连接master，而此时master并没有出现故障，所以，这就需要多个sentinel都一致认为该master有问题，才可以进行下一步操作，这就保证T了公平性和高可用。

- sentinel auth-pass <master-name> <password>：master设置了密码，连接master服务的密码。

其他参数：

![image-20240306130337523](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403061303943.png)



## 修改sentinel.conf配置